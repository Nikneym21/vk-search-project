#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–≥–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ VKSearchPlugin
–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ path
sys.path.insert(0, os.path.abspath('.'))

from src.plugins.vk_search.vk_search_plugin import VKSearchPlugin


async def test_improved_filtering():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""

    print("üß™ –¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–≥–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ VKSearchPlugin")
    print("=" * 60)

    # –°–æ–∑–¥–∞–µ–º –ø–ª–∞–≥–∏–Ω
    vk_search_plugin = VKSearchPlugin()

    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–±—Ä–∞–∑—Ü—É —ç—Ç–∞–ª–æ–Ω–∞
    posts = [
        # –î–æ–ª–∂–Ω—ã –ü–†–û–ô–¢–ò —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é (–∏–∑ —ç—Ç–∞–ª–æ–Ω–∞)
        {
            "text": "–õ–∏—Å –ø–µ—Ä–µ–¥–∞–µ—Ç –≤—Å–µ–º –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
            "link": "https://vk.com/wall-25943575_1158294"
        },
        {
            "text": "–õ–∏—Å –ø–µ—Ä–µ–¥–∞–µ—Ç –≤—Å–µ–º –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
            "link": "https://vk.com/wall-125866183_516874"
        },
        {
            "text": "–î–∞–∂–µ –≤ –±–æ–µ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —á–µ–ª–æ–≤–µ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è —á–µ–ª–æ–≤–µ–∫–æ–º.\n–î–æ–±—Ä–æ –≤—Å–µ–≥–¥–∞ –Ω–∞–π–¥—ë—Ç —Å–µ–±–µ –º–µ—Å—Ç–æ ‚Äî –¥–∞–∂–µ –Ω–∞ –ø–µ—Ä–µ–¥–æ–≤–æ–π.",
            "link": "https://vk.com/wall299788145_3101"
        },
        {
            "text": "–ù–∞—Å –Ω–µ —Å–ª–æ–º–∏—Ç—å. –ù–∏ –ø–µ–ø–ª–æ–º, –Ω–∏ —Ä–∞–∑—Ä—É—Ö–æ–π.\n–ê –º—è–≥–∫–∏–π –º–∏—à–∫–∞ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ –ø–æ–±–µ–¥–∞ –Ω—É–∂–Ω–∞ —Ä–∞–¥–∏ –±—É–¥—É—â–µ–≥–æ.",
            "link": "https://vk.com/wall-123456789_1234"
        },

        # –î–æ–ª–∂–Ω—ã –ù–ï –ü–†–û–ô–¢–ò —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é (–Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ)
        {
            "text": "–≠–ø–æ—Ö–∞ –ø—É–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–π–Ω –∏ –¥—Ä—É–≥–∞—è –∏—Å—Ç–æ—Ä–∏—è –±–µ–∑ –Ω–∞—à–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤",
            "link": "https://vk.com/wall-216074633_3068"
        },
        {
            "text": "–ö–∞–∫–æ–π-—Ç–æ –ø–æ—Å—Ç –ø—Ä–æ –Ω–æ–≤–æ—Å—Ç–∏ –±–µ–∑ –Ω–∞—à–∏—Ö —Ñ—Ä–∞–∑",
            "link": "https://vk.com/wall-987654321_5678"
        }
    ]

    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
    keywords = [
        "–õ–∏—Å –ø–µ—Ä–µ–¥–∞–µ—Ç –≤—Å–µ–º –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",
        "–î–∞–∂–µ –≤ –±–æ–µ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —á–µ–ª–æ–≤–µ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è —á–µ–ª–æ–≤–µ–∫–æ–º.",
        "–î–æ–±—Ä–æ –≤—Å–µ–≥–¥–∞ –Ω–∞–π–¥—ë—Ç —Å–µ–±–µ –º–µ—Å—Ç–æ ‚Äî –¥–∞–∂–µ –Ω–∞ –ø–µ—Ä–µ–¥–æ–≤–æ–π.",
        "–ù–∞—Å –Ω–µ —Å–ª–æ–º–∏—Ç—å. –ù–∏ –ø–µ–ø–ª–æ–º, –Ω–∏ —Ä–∞–∑—Ä—É—Ö–æ–π.",
        "–ê –º—è–≥–∫–∏–π –º–∏—à–∫–∞ ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ –ø–æ–±–µ–¥–∞ –Ω—É–∂–Ω–∞ —Ä–∞–¥–∏ –±—É–¥—É—â–µ–≥–æ."
    ]

    print(f"üìä –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:")
    print(f"   –ü–æ—Å—Ç–æ–≤: {len(posts)}")
    print(f"   –ö–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {len(keywords)}")
    print()

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
    filtered_posts = vk_search_plugin._strict_local_filter(posts, keywords, exact_match=True)

    print(f"üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:")
    print(f"   –ò—Å—Ö–æ–¥–Ω–æ: {len(posts)} –ø–æ—Å—Ç–æ–≤")
    print(f"   –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: {len(filtered_posts)} –ø–æ—Å—Ç–æ–≤")
    print()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    print("‚úÖ –ü—Ä–æ—à–µ–¥—à–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ—Å—Ç—ã:")
    for i, post in enumerate(filtered_posts, 1):
        print(f"   {i}. {post['text'][:50]}...")
        print(f"      –°–æ–≤–ø–∞–¥–µ–Ω–∏—è: {post.get('keywords_matched', [])}")
        print()

    # –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    expected_count = 4  # –î–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ –ø–µ—Ä–≤—ã–µ 4 –ø–æ—Å—Ç–∞

    if len(filtered_posts) == expected_count:
        print("üéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù!")
        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: {expected_count} –ø–æ—Å—Ç–æ–≤")
        print(f"   –ü–æ–ª—É—á–µ–Ω–æ: {len(filtered_posts)} –ø–æ—Å—Ç–æ–≤")
    else:
        print("‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù!")
        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: {expected_count} –ø–æ—Å—Ç–æ–≤")
        print(f"   –ü–æ–ª—É—á–µ–Ω–æ: {len(filtered_posts)} –ø–æ—Å—Ç–æ–≤")

    return len(filtered_posts) == expected_count


if __name__ == "__main__":
    result = asyncio.run(test_improved_filtering())
    print(f"\nüèÅ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞: {'–ü–†–û–ô–î–ï–ù' if result else '–ù–ï –ü–†–û–ô–î–ï–ù'}")

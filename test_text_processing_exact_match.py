import unittest
from src.plugins.text_processing.text_processing_plugin import TextProcessingPlugin

PHRASES = [
    "С верой в сердце и флагом в руках. Брат прислал с передовой.",
    "На двух колёсах быстрее и тише. Доставляем подарки противнику",
    "Позывной Клещ",
    "От воина с позывным «100» приветы всем с Запорожского направления. Полк 1462, 3 бат — на связи. Работаем, братья!",
    "Техника противника на Запорожском направлении горит отлично",
    "Наша пушистая поддержка всегда рядом.",
    "Наш человек на позиции. Всё под контролем.",
    "Рабочие будни мотострелков: два колеса, бронежилет и верный дрон над головой.",
    "Очередной культурный объект взят под охрану — теперь здесь только русский порядок.",
    "Моё транспортное средство после лёгкой прогулки по пересечёнке. Слава России.",
    "Тройка удачи на позициях! Слева — мастер по шуткам, справа — по миномётам.",
    "Наши бойцы перед минированием позиций",
    "Наш воин в зоне проведения СВО",
    "Кошу укроп. Инструмент — проверенный, настрой — уверенный",
    "Наши бойцы в зоне СВО. Сильные, спокойные, собранные. Делают свою работу",
    "Потеплело...+32  Лето на позициях своё, особенное.",
    "Работаем слаженно, молча, по делу. Всем, кто за нас — низкий поклон. Мы не подведём",
    "Связист по кличке «Бумер»  На передовой помогает нашим бойцам — не лает зря, держит хвост пистолетом и всегда рядом",
    "Работаем с душой, стоим с братьями. Привет всем, кто на связи. Двигаемся вперёд!",
    "Позывной «ВАМПИР». Боец Александрийской бригады «Чёрные гусары».",
    "Боец на связи. Передаём привет из зоны СВО. Работа идёт, позиции на замке, настроение — как надо",
    "Броник не давит, потому что уже привык, а очки — на случай яркой Победы. Короче, в пути. Не переключайтесь!",
    "Военнослужащий Отдела мобильных действий Пограничной службы ФСБ",
    "Плечом к плечу, без лишних слов. Каждый знает, за что стоит",
    "Привет солнечной Бурятии от бойца с позывным «ТУРИСТ»",
    "Позывной «ПЕТРОВИЧ». Контрактник из Иркутской области. В зоне СВО с 2024 года. - Передаю привет всем, кто меня знает. Ничего боятся не надо. Смерть ищет того, кто послабже. А кто её не боится, она обходит стороной. Ну и дураком быть не надо – самому её искать.",
    "Боевой напарник нашёл броню потеплее. На позициях не шумит, в разведку не просится",
    "Наши бойцы на фоне уничтоженной американской БМП M2 Bradley. Благодарим за поставку — утилизация прошла успешно.",
    "За нами правда, за нами сила",
    "Делаем свою работу, как надо. Без лишних слов — только дело",
    "Боец 155-й отдельной гвардейской бригада морской пехоты, позывной «ЕМЕЛЯ»",
    "По географии пока трояк, но по ориентированию — твёрдая пятёрка Школа жизни: урок — боевой, перемена — под выстрелы.",
    "Отдыхаю на даче у деда… Танк-дом, мангал встроенный, вентиляция круговая",
    "Каждый день — шаг вперёд, каждый выезд — вклад в Победу. За наших. За память. За будущее",
    "Каждый выезд — шаг ближе к победе. Мы не герои, просто делаем своё дело.",
    "Пока есть такие парни — нас не сломать. Работаем на победу!",
    "Связь есть, настрой боевой, а главное — вера в правое дело. Мы русские — с нами Бог!",
    "Позывной — «МОГИЛА» . Кто понял, тот понял. Привет с передка всем, кто по нам скучает",
    "В каждом шаге — верность присяге. Стоим на своём, не дрогнем",
    "Контент с передовой, как говорится, и в бой, и в блогеры",
    "Пока кто-то жалуется на офис, у нас тут — блиндаж, фанера и автомат под рукой. Спасибо тем, кто не забывает и поддерживает.",
    "В таких условиях понимаешь, кто рядом по-настоящему свой.",
    "Боец морской пехоты Тихоокеанского флота, позывной «КИРЯ»",
    "Минутка перезагрузки. День как день — жара, пыль, позиция. Всё под контролем",
    "Боевые туристы. Автомат вместо селфи-палки, экипировка — по уставу, боевой дух — выше дронов. Враг — условно недоволен",
    "Не маленькие — а компактные. Не котята — а мобильная противомышиная группа Боевой состав на базе, ведут наблюдение, работают скрытно и эффективно.",
    "Позывной — ТИБОР. Военнослужащий 15-й отдельной гвардейской мотострелковой Александрийской бригады. С доброй улыбкой, но с характером — такой и должен быть настоящий воин.",
    "На выезде. Погода норм, настрой боевой, улыбка под маской — это уже классика",
    "Каждый день здесь — это шаг вперёд ради будущего. Мы на своём месте. Мы за Россию",
    "Позывной «Ясыть». Участница СВО, ветеран боевых действий и тактический медик. Недавно подписала новый контракт с Минобороны и совсем скоро снова отправляется в зону СВО. Уверенность в глазах, опыт за плечами и крепкая вера в дело. Удачи и береги себя, сестра по оружию!",
    "Всем мирного неба и спасибо за поддержку!",
    "Своих не бросаем, работаем чётко. Все живы-здоровы — значит, двигаемся дальше",
    "С Богом в сердце и верой в Победу! Работаем",
    "С верой, надеждой и молитвой. Христос с нами — а значит, мы непобедимы!",
    "Нашёл автомат с газировкой из детства. Не работает, но ностальгия — зашкаливает!",
    "Привет с передовой! Держим направление, всё по плану",
    "Залетели на точку, установили «аргумент» для переговоров. Настроение бодрое, цели понятны",
    "На фото — боец одного из подразделений с трофейным украинским UAR-15. Сувенир нашли, по назначению применим. Хозяева больше не нуждаются",
    "На передке всё стабильно. Работаем, братья, плечом к плечу",
    "Боец 155-й отдельной гвардейской бригада морской пехоты, позывной «ПУМА»",
    "Военнослужащий ВС РФ в районе н.п. Копани, Запорожское направление, 2023 год.",
    "Работаем слаженно, уверенно и по совести. За пацанов – до победы",
    "Наш боевой напарник — всегда на страже, всегда рядом. Верный друг, которому можно доверять. Пёс с характером, но с добрым сердцем",
    "Пока кто-то жалуется на погоду, мы просто делаем своё дело. Надёжная броня, верные товарищи и вера в победу — с таким составом всё по плечу",
    "Тихая минутка среди зелени, но всегда на чеку. С любовью из зоны СВО",
    "Даже в самых суровых условиях мы остаёмся людьми. Добро рядом, даже когда вокруг война",
    "Вера, сила и спокойствие — с таким настроем идём. Всем привет из зоны СВО",
    "Сильная, надёжная, с добрым сердцем. 1-й ДРШБр «Волки», позывной «МУРА»",
    "Работаем по плану, с любовью к Родине и уважением к делу",
    "Бригада Калмыкии на передовой. За правду, за своих",
    "Инженер-сапёр, позывным ХАКЕР из 155-й бригады морской пехоты ТОФ. Работа тихая, но критически важная",
    "Позывной «ТУРИСТ», экскурсия по останкам западной техники завершена",
    "Работаем ради тех, кого любим Берегите себя, а мы – вас!",
    "Боевой привет из зоны СВО! Работаем чётко, техника на ходу, дух на высоте",
    "Служим Родине не словами, а делом.",
    "Работа ждёт — а мы к ней готовы. Вперёд за своих и за правду.",
    "Тачка на прокачку по-полевому Руки растут откуда надо — сделали багги сами, теперь гоняем между позициями, как в Mad Max.",
    "Улыбки под небом Донбасса — потому что знаем, за что стоим",
    "Всё просто: экипировка, автомат и немного везения. Привет всем, кто ждёт — держим темп!",
    "Выполняем задачи, как учили — точно, слаженно, с верой в дело.",
    "Взял под опеку местного охранника — теперь патрулируем вместе  Пусть война вокруг, но внутри должно оставаться что-то человеческое.",
    "Разные судьбы, разный возраст, но одна цель и одна команда. Всем, кто ждёт и поддерживает — низкий поклон",
    "Медик одного из подразделений Александрийской бригады. Позывной — БАЦИЛЛА. Где другим страшно — он работает.",
    "Живы, целы, на связи.",
    "Позывной «ТАЙГА»,  желает вам продуктивной рабочей недели Берегите себя, работайте честно — каждый на своём фронте.",
    "Цветы — для красоты, автомат — по необходимости. Служим и не забываем, ради чего всё это.",
    "Оператор на связи не выводится — заряжается от полевого телефона",
    "Уничтоженный украинский бронеавтомобиль «Новатор»",
    "Когда говорил, что пойду в разведку и постараюсь слиться с местностью — имел немного другое в виду...",
    "Те, кого не видно — но кого боятся. СпН России — всегда первыми, всегда в тени. Готовы к любому сценарию",
    "Боец отдельной гвардейской бригада морской пехоты, позывной «СИНИЦА»",
    "Связь есть, настроение тоже. Всем, кто ждет — привет, держимся!",
    "Передаю сердечко тем, кто ждёт",
    "Держим позиции и не теряем улыбку. Всем, кто за нас — спасибо, мы вас не подведём!",
    "Пока сверху тихо, есть пару минут на красоту. Привет с передовой, где даже в броне можно почувствовать себя человеком.",
    "Между жизнью и смертью — тонкая грань, и каждый день мы на ней стоим.",
    "Место не называем, лица не показываем. А результат — узнаете потом.",
    "Зовём его просто: Боец. Спит рядом, радуется каждому новому дню и поднимает настроение. Пусть у всех будет свой хвостатый друг даже в самые непростые времена.",
    "Каждый день — работа, которую не видно за новостями, но мы её делаем. Спасибо тем, кто поддерживает.",
    "Разные судьбы — одна форма, один флаг, одна цель.",
    "Служим молча, но от сердца.",
    "Когда коллеги зовут на вечернюю прогулку по полю – не откажешься!",
    "Здесь каждый день — экзамен на стойкость. И мы его сдаём.",
    "Без лишних комментариев.",
    "Немного пушистого тепла в этом всём безумии.",
    "На броне, с верной лентой и холодным взглядом. Готовы ко всему",
    "Связь есть, задача ясна, мотобратья на позиции",
    "Привет из лесополосы Подписал с душой — за родной Курск! Пусть долетит точно. Всем нашим — сил, терпения и скорейшего возвращения домой.",
    "Питер Бенджамин Паркер получил гражданство ДНР.",
    "Отправитель: Питер Паркер — Человек-Паук",
    "Подпись к фото: Сбежал из Нью-Йорка, теперь на новом задании. Донецк принял тепло, работаю инкогнито 🕸️",
    "Преступность не дремлет, даже тут. P.S. Костюм не стесняет движений — проверено.",
    "Мы не ищем лёгких путей — мы по ним прокладываем маршрут",
    "Погнали на дело. Настрой боевой, погода отличная. Работаем",
    "Выдвигаемся в сторону позиций. Команда заряжена",
    "Передаю привет родным и всем, кто ждёт. Всё под контролем",
    "Настроение нормальное, обстановка рабочая. Всем родным привет — держим строй, стоим за своих. Победа будет за нами",
    "Маленький символ мира среди будней СВО. Служим с душой, с добром и с верой",
    "Разведчик  армейского спецназа на Бахмутском участке фронта. Связь, координация и немного юмора — залог успешной работы.",
    "Команда в сборе. Настрой как всегда серьёзный, задачи на сегодня получены — выдвигаемся. На бронике напоминание от мамы, чтоб лишний раз не расслаблялся  Всем родным привет с передовой!",
    "Когда у тебя есть пулемёт, вера в победу и стильные кроссовки — никакой враг не страшен",
    "Военная комендатура на посту. Порядок — дело принципа. Всё по уставу, но с душой. Спокойствие в тылу — наша забота",
    "Гвардеец из Александрийской бригады «Чёрные гусары». Уверенность в глазах, надёжность в руках. Работаем чётко, братцы",
    "На броне как дома — бойцы 40-й гвардейской бригады морской пехоты держат курс вперёд. Улыбка, спокойствие и уверенность — такие не подведут",
    "Нашёл нового боевого товарища — зовут Пуля Настоящий комочек тепла посреди всех тревог.",
    "Для тех, кто ждёт, верит и молится. Мы не забываем о самом главном — о вас",
    "Боец морской пехоты Тихоокеанского Флота с позывным «ДАВЫД»",
    "Удачная сегодня вышла охота — боец возвращается с трофейным дроном",
    "Бойцы из Бурятии передают тёплый привет землякам",
    "Боец 155-й отдельной гвардейской бригада морской пехоты, позывной «НАЙК»",
    "От души, братцы! Работаем чётко, настрой боевой. Пока есть минутка — сигарета, фото на память и снова в дело",
    "Вдохнул аромат — вспомнил дом, родных, жизнь до всего этого. Друзья, берегите себя и цените простые моменты. Они — самые настоящие",
    "Жив-здоров, настроение боевое. Передаю привет домой, родным и друзьям — всё под контролем",
    "Железный конь бодрый, как и настрой. Привет с линии соприкосновения",
    "Врагу — отпор, своим — уважение. Боевой дух на максимуме! Берегите себя там, а мы тут порядок наводим",
    "Мы справимся! Ждите нас, и мы вернёмся с Победой",
    "Настоящие мужчины с ясным взглядом и твёрдой волей.\nНа таких держится передовая — и страна.",
    "Бойцы передали весточку с фронта\nБерегите себя, побольше вам здоровья и сил",
    "В короткие минуты отдыха бойцы снова вместе — плечом к плечу, как в бою.\nЗдесь каждый знает: за спиной — Родина, и мы не подведём.",
    "Бойцы  40-й отдельной Гвардейской бригады Морской Пехоты Тихоокеанского флота.",
    "Рабочий момент с передовой. Стены рушатся — дух нет.\nСила — в умении стоять до конца, несмотря ни на что.",
    "Родина призвала и мы сказали \"Есть\"",
    "ВДВ на БМД. Доброго дня",
    "Лис передает всем доброе утро",
    "Привет родной Бурятии от штурмовиков танковой бригады с Южно-Донецкого направления",
    "Даже в боевых условиях человек остаётся человеком.\nДобро всегда найдёт себе место — даже на передовой.",
    "Нас не сломить. Ни пеплом, ни разрухой.\nА мягкий мишка — напоминание, что победа нужна ради будущего.",
    "Русский воин стоит на своей земле.\nГде солнце заходит — там наш рубеж."
]

class TestTextProcessingPlugin(unittest.TestCase):
    def setUp(self):
        self.text_plugin = TextProcessingPlugin()

    def test_exact_match_cleaned(self):
        exact_match_count = 0
        in_big_text_count = 0
        with_emoji_count = 0
        not_in_unrelated_count = 0
        for phrase in PHRASES:
            # 1. Точное совпадение
            if self.text_plugin.clean_text_completely(phrase) in self.text_plugin.clean_text_completely(phrase):
                exact_match_count += 1
            self.assertIn(
                self.text_plugin.clean_text_completely(phrase),
                self.text_plugin.clean_text_completely(phrase)
            )
            # 2. В большом тексте
            big_text = f"Вчера был бой. {phrase} Всё прошло успешно."
            if self.text_plugin.clean_text_completely(phrase) in self.text_plugin.clean_text_completely(big_text):
                in_big_text_count += 1
            self.assertIn(
                self.text_plugin.clean_text_completely(phrase),
                self.text_plugin.clean_text_completely(big_text)
            )
            # 3. С эмодзи и хэштегом
            emoji_text = f"😀 {phrase} #герой"
            if self.text_plugin.clean_text_completely(phrase) in self.text_plugin.clean_text_completely(emoji_text):
                with_emoji_count += 1
            self.assertIn(
                self.text_plugin.clean_text_completely(phrase),
                self.text_plugin.clean_text_completely(emoji_text)
            )
            # 4. Нет совпадения
            unrelated = "Совсем другой текст"
            if self.text_plugin.clean_text_completely(phrase) not in self.text_plugin.clean_text_completely(unrelated):
                not_in_unrelated_count += 1
            self.assertNotIn(
                self.text_plugin.clean_text_completely(phrase),
                self.text_plugin.clean_text_completely(unrelated)
            )
        print(f"\nПрошли фильтрацию (точное совпадение): {exact_match_count} из {len(PHRASES)}")
        print(f"Прошли фильтрацию (в большом тексте): {in_big_text_count} из {len(PHRASES)}")
        print(f"Прошли фильтрацию (с эмодзи): {with_emoji_count} из {len(PHRASES)}")
        print(f"Не найдено в несвязанном тексте: {not_in_unrelated_count} из {len(PHRASES)}")

if __name__ == "__main__":
    unittest.main(exit=False)
    # После тестов считаем посты с фразами
    import csv
    import os
    def count_posts_with_phrases(csv_path, phrases, text_plugin):
        with open(csv_path, encoding="utf-8") as f:
            reader = csv.DictReader(f, delimiter=';')
            posts = list(reader)
        matched_posts = []
        unmatched_posts = []
        phrases_clean = [text_plugin.clean_text_completely(p) for p in phrases]
        phrase_found = [False] * len(phrases)
        for post in posts:
            text = post.get('Текст', '')
            text_clean = text_plugin.clean_text_completely(text)
            matched = False
            for i, phrase_clean in enumerate(phrases_clean):
                if phrase_clean in text_clean:
                    matched = True
                    phrase_found[i] = True
            if matched:
                matched_posts.append(post)
            else:
                unmatched_posts.append(post)
        print(f"\nПостов, содержащих хотя бы одну фразу: {len(matched_posts)} из {len(posts)} ({len(matched_posts)/len(posts)*100:.1f}%)")
        if unmatched_posts:
            print(f"Посты без совпадения (первые 10):")
            for post in unmatched_posts[:10]:
                print(f"  - {post.get('Ссылка', '')} | {post.get('Текст', '')[:60]}...")
            if len(unmatched_posts) > 10:
                print(f"  ... и ещё {len(unmatched_posts)-10} постов")
        else:
            print("Все посты содержат хотя бы одну фразу.")
        unused_phrases = [phrases[i] for i, found in enumerate(phrase_found) if not found]
        if unused_phrases:
            print(f"\nФразы, не найденные ни в одном посте:")
            for phrase in unused_phrases:
                print(f"  - {phrase}")
        else:
            print("\nВсе фразы найдены хотя бы в одном посте.")
        return matched_posts
    plugin = TextProcessingPlugin()
    csv_path = os.path.join(os.path.dirname(__file__), "168_24.07_18.04_25.07.2025.csv")
    count_posts_with_phrases(csv_path, PHRASES, plugin) 